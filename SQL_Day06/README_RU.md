# Day 06 - Piscine SQL: Let's improve customer experience

## Обзор проекта

Этот день посвящен расширению бизнес-функциональности базы данных путем добавления системы персональных скидок. В рамках проекта решены 6 практических задач, демонстрирующих проектирование таблиц, добавление ограничений, заполнение данных и автоматизацию процессов.

---

## Теория: Проектирование базы данных

![D06_01](misc/images/D06_01.png)

### Основные концепции

* **Структура данных** — основа стабильности и производительности системы.

### Логическое проектирование

* Описание бизнес-сущностей и их взаимосвязей.
* Фокус на отражении реального мира.

### Физическое проектирование

* Реализация логической модели с учетом производительности.
* Выбор типов данных, индексов, ограничений.

### Трехэтапный подход к проектированию

1. **Концептуальная модель** — бизнес-требования.
2. **Логическая модель** — сущности и связи.
3. **Физическая модель** — реализация в СУБД.

---

* *Логическая модель: **отражение бизнес-процессов***
![D06_02](misc/images/D06_02.png)

* *Физическая модель: **оптимизация для производительности***
![D06_03](misc/images/D06_03.png)

---

## База данных

### Схема базы данных

![schema](misc/images/schema.png)

---

### Описание таблиц

#### `pizzeria`

* `id` — первичный ключ
* `name` — название пиццерии
* `rating` — средний рейтинг (0–5 баллов)

#### `person`

* `id` — первичный ключ
* `name` — имя человека
* `age` — возраст
* `gender` — пол
* `address` — адрес

#### `menu`

* `id` — первичный ключ
* `pizzeria_id` — внешний ключ к `pizzeria`
* `pizza_name` — название пиццы
* `price` — цена

#### `person_visits`

* `id` — первичный ключ
* `person_id` — внешний ключ к `person`
* `pizzeria_id` — внешний ключ к `pizzeria`
* `visit_date` — дата посещения

#### `person_order`

* `id` — первичный ключ
* `person_id` — внешний ключ к `person`
* `menu_id` — внешний ключ к `menu`
* `order_date` — дата заказа

#### `person_discounts` (новая таблица)

* `id` — первичный ключ
* `person_id` — внешний ключ к `person`
* `pizzeria_id` — внешний ключ к `pizzeria`
* `discount` — размер скидки в процентах

---

## Ключевые особенности

* 6 упражнений на расширение модели данных
* Реализация системы персональных скидок
* Добавление ограничений целостности данных
* Автоматизация генерации первичных ключей

> **Важно:** Состояние базы данных сохраняется с предыдущих дней

---

## Структура проекта

```
src/
├── ex00
│   └── day06_ex00.sql
├── ex01
│   └── day06_ex01.sql
├── ex02
│   └── day06_ex02.sql
├── ex03
│   └── day06_ex03.sql
├── ex04
│   └── day06_ex04.sql
├── ex05
│   └── day06_ex05.sql
└── ex06
    └── day06_ex06.sql
```

---

## Задачи

### Exercise 00 - Discounts, discounts, everyone loves discounts

**Задание:**
Создать таблицу `person_discounts` со следующими полями:

* `id` — первичный ключ
* `person_id` — внешний ключ к `person`
* `pizzeria_id` — внешний ключ к `pizzeria`
* `discount` — размер скидки в процентах (числовой тип)

**Требования:**

* Явные имена для ограничений внешних ключей:

  * `fk_person_discounts_person_id`
  * `fk_person_discounts_pizzeria_id`

---

### Exercise 01 - Let's set personal discounts

**Задание:**
Заполнить таблицу `person_discounts` на основе истории заказов (`person_order`).

**Правила расчета скидки:**

* 1 заказ = 10.5%
* 2 заказа = 22%
* 3+ заказов = 30%

**Технические требования:**

* Использовать `INSERT INTO ... SELECT ...`
* Генерировать `id` с помощью `ROW_NUMBER() OVER ()`

---

### Exercise 02 - Let's recalculate a history of orders

**Задание:**
Вернуть историю заказов с расчетом цены со скидкой. Отсортировать по имени человека и названию пиццы.

**Ожидаемый формат:**

| name   | pizza\_name  | price | discount\_price | pizzeria\_name |
| ------ | ------------ | ----- | --------------- | -------------- |
| Andrey | cheese pizza | 800   | 624             | Dominos        |
| ...    | ...          | ...   | ...             | ...            |

---

### Exercise 03 - Improvements are in a way

**Задание:**
Создать уникальный индекс `idx_person_discounts_unique` для предотвращения дубликатов пар (`person_id`, `pizzeria_id`).
Предоставить доказательство использования индекса с помощью `EXPLAIN ANALYZE`.

---

### Exercise 04 - We need more Data Consistency

**Задание:**
Добавить ограничения для таблицы `person_discounts`:

* `person_id NOT NULL` → `ch_nn_person_id`
* `pizzeria_id NOT NULL` → `ch_nn_pizzeria_id`
* `discount NOT NULL` → `ch_nn_discount`
* Значение по умолчанию для `discount = 0`
* `discount` в диапазоне от 0 до 100 → `ch_range_discount`

---

### Exercise 05 - Data Governance Rules

**Задание:**
Добавить комментарии к таблице `person_discounts` и ее колонкам, объясняющие бизнес-логику.

---

### Exercise 06 - Let's automate Primary Key generation

**Задание:**

* Создать последовательность `seq_person_discounts`, начиная с 1
* Установить последовательность как значение по умолчанию для `id`
* Установить текущее значение последовательности = максимальный `id` + 1

**Ограничение:**
Запрещено использовать хардкодинг количества строк.

---

## Технологии

* **PostgreSQL** — система управления реляционными базами данных
* **ANSI SQL** — стандартизированный язык запросов
* **psql / pgAdmin** — инструменты для работы с PostgreSQL

---

## Как использовать

1. Установите PostgreSQL
2. Восстановите БД из [script](materials/model.sql) (с учетом изменений предыдущих дней)
3. Для каждого упражнения выполните соответствующий SQL-файл
4. Проверьте результаты:

   * Для Exercise 02:
     `SELECT * FROM ...`
   * Для Exercise 03:
     `EXPLAIN ANALYZE ...`
   * Для Exercise 05:
     `\d+ person_discounts`

> **Важно:**
> Упражнения должны выполняться последовательно, так как они зависят друг от друга.
